name: Test Quality Gates

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/test-quality-gates.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'

jobs:
  test-quality:
    name: Test Quality Checks
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # ============================================================================
      # Phase 1: Run All Tests
      # ============================================================================

      - name: Run Unit Tests
        run: |
          echo "::group::Unit Tests"
          ./gradlew test --tests '*Test' --exclude-task pitest
          echo "::endgroup::"

      - name: Run Property-Based Tests
        run: |
          echo "::group::Property-Based Tests"
          ./gradlew test --tests '*PropertyTest'
          echo "::endgroup::"

      - name: Run Integration Tests
        run: |
          echo "::group::Integration Tests"
          ./gradlew test --tests '*IntegrationTest'
          echo "::endgroup::"

      # ============================================================================
      # Phase 2: Code Coverage
      # ============================================================================

      - name: Generate JaCoCo Coverage Report
        run: |
          echo "::group::Code Coverage"
          ./gradlew jacocoTestReport
          echo "::endgroup::"

      - name: Verify Code Coverage Threshold
        run: |
          echo "::group::Coverage Threshold Check"
          ./gradlew jacocoTestCoverageVerification
          echo "::endgroup::"

      # ============================================================================
      # Phase 3: Mutation Testing (The Real Test of Test Quality)
      # ============================================================================

      - name: Run Mutation Tests with Pitest
        id: pitest
        run: |
          echo "::group::Mutation Testing"
          ./gradlew pitest --no-daemon
          echo "::endgroup::"
        continue-on-error: true

      - name: Parse Mutation Coverage
        id: mutation_coverage
        run: |
          # Extract mutation coverage from Pitest report
          if [ -f build/reports/pitest/index.html ]; then
            # Parse mutation coverage percentage from HTML report
            MUTATION_COVERAGE=$(grep -oP 'Line Coverage.*?(\d+)%' build/reports/pitest/index.html | grep -oP '\d+' || echo "0")
            echo "mutation_coverage=$MUTATION_COVERAGE" >> $GITHUB_OUTPUT

            # Parse test strength
            TEST_STRENGTH=$(grep -oP 'Mutation Coverage.*?(\d+)%' build/reports/pitest/index.html | grep -oP '\d+' || echo "0")
            echo "test_strength=$TEST_STRENGTH" >> $GITHUB_OUTPUT

            echo "ðŸ“Š Mutation Coverage: $TEST_STRENGTH%"
          else
            echo "âš ï¸  Pitest report not found"
            echo "mutation_coverage=0" >> $GITHUB_OUTPUT
            echo "test_strength=0" >> $GITHUB_OUTPUT
          fi

      # ============================================================================
      # Phase 4: Performance Testing (New in Phase 4)
      # ============================================================================

      - name: Run Performance Benchmarks
        id: jmh
        run: |
          echo "::group::Performance Benchmarks"
          ./gradlew jmh || true
          echo "::endgroup::"
        continue-on-error: true

      - name: Check Performance Baseline
        run: |
          if [ -f "performance-baseline.json" ] && [ -f "build/reports/jmh/results.json" ]; then
            echo "::notice::Performance baseline found - comparing results"
            echo "::notice::Review build/reports/jmh/results.json for regressions"
          else
            echo "::warning::No performance baseline found"
            echo "::warning::Create baseline with: ./gradlew jmh && cp build/reports/jmh/results.json performance-baseline.json"
          fi

      # ============================================================================
      # Phase 4: Quality Gates Enforcement (Updated threshold: 65% â†’ 70%)
      # ============================================================================

      - name: Enforce Mutation Coverage Threshold
        run: |
          THRESHOLD=70
          ACTUAL=${{ steps.mutation_coverage.outputs.test_strength }}

          echo "::notice::Mutation Coverage: $ACTUAL% (Minimum: $THRESHOLD%)"

          if [ "$ACTUAL" -lt "$THRESHOLD" ]; then
            echo "::error::âŒ Mutation coverage ($ACTUAL%) is below threshold ($THRESHOLD%)"
            echo "::error::This means your tests are not catching enough bugs!"
            echo "::error::Add more specific assertions and property-based tests."
            echo "::error::Run: ./gradlew pitest && ./scripts/analyze-mutations.sh --verbose"
            exit 1
          else
            echo "::notice::âœ… Mutation coverage ($ACTUAL%) meets threshold ($THRESHOLD%)"
          fi

      # ============================================================================
      # Phase 4: Track Quality Metrics Over Time
      # ============================================================================

      - name: Track Quality Metrics
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          echo "::group::Quality Metrics Tracking"
          ./scripts/track-quality-metrics.sh
          echo "::endgroup::"
        continue-on-error: true

      - name: Upload Quality Metrics History
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: actions/upload-artifact@v4
        with:
          name: quality-metrics-history
          path: backend/quality-metrics-history.csv
          retention-days: 365  # Keep for 1 year to track long-term trends

      # ============================================================================
      # Phase 5: Upload Test Reports
      # ============================================================================

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            backend/build/reports/tests/
            backend/build/test-results/
          retention-days: 30

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            backend/build/reports/jacoco/
          retention-days: 30

      - name: Upload Mutation Testing Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: |
            backend/build/reports/pitest/
          retention-days: 30

      # ============================================================================
      # Phase 6: Publish Test Results to PR
      # ============================================================================

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'backend/build/test-results/test/TEST-*.xml'
          check_name: 'Test Results'
          detailed_summary: true
          include_passed: true

      - name: Comment PR with Test Quality Metrics
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const mutationCoverage = '${{ steps.mutation_coverage.outputs.test_strength }}';
            const lineCoverage = '${{ steps.mutation_coverage.outputs.mutation_coverage }}';
            const threshold = 70;  // Phase 4: Increased from 65% to 70%

            const passedMutation = parseInt(mutationCoverage) >= threshold;
            const status = passedMutation ? 'âœ… PASSED' : 'âŒ FAILED';
            const emoji = passedMutation ? 'ðŸŽ‰' : 'âš ï¸';

            const comment = `## ${emoji} Test Quality Report ${status}

            ### Mutation Testing Results (Phase 4)
            | Metric | Value | Status |
            |--------|-------|--------|
            | **Mutation Coverage** | **${mutationCoverage}%** | ${passedMutation ? 'âœ…' : 'âŒ'} ${passedMutation ? 'Meets' : 'Below'} threshold (${threshold}%) |
            | Line Coverage | ${lineCoverage}% | â„¹ï¸ Reference |

            ### What is Mutation Coverage?

            Mutation coverage measures **test quality**, not just code coverage. It works by:
            1. ðŸ§¬ Introducing bugs into your code (mutations)
            2. ðŸ§ª Running your tests
            3. âœ… Checking if tests catch the bugs

            **${mutationCoverage}% mutation coverage** means your tests catch ${mutationCoverage}% of introduced bugs.

            ${passedMutation ?
              '### âœ… Excellent Work!\n\n' +
              'Your tests meet the Phase 4 standard (70%+) and catch most bugs!\n\n' +
              '**Continuous Improvement:**\n' +
              '- Review remaining survived mutations for edge cases\n' +
              '- Consider adding property-based tests for complex logic\n' +
              '- Run \`./scripts/analyze-mutations.sh --verbose\` for detailed analysis' :
              '### âš ï¸ Action Required\n\n' +
              'Your tests are not catching enough bugs. To improve:\n\n' +
              '**Quick Fix Steps:**\n' +
              '1. Run: \`./gradlew pitest\`\n' +
              '2. Analyze: \`./scripts/analyze-mutations.sh --verbose\`\n' +
              '3. Open: \`build/reports/pitest/index.html\`\n' +
              '4. Fix survived mutations (see red highlights)\n\n' +
              '**Common Improvements:**\n' +
              '1. **Replace vague assertions** with specific ones\n' +
              '   - âŒ \`verify(repo).save(any())\`\n' +
              '   - âœ… \`verify(repo).save(argThat(m -> m.getCalories() == 500))\`\n\n' +
              '2. **Add property-based tests** for mathematical invariants\n' +
              '   - Test universal truths across 1000+ random inputs\n\n' +
              '3. **Test edge cases** (zero, negative, boundary values)\n\n' +
              '4. **Use independent calculations** in assertions\n' +
              '   - Don\'t mirror the implementation\n\n' +
              'ðŸ“š See \`backend/docs/CI_CD_QUALITY_GATES.md\` for detailed guide'
            }

            ### ðŸ“Š Detailed Reports

            Check the **Artifacts** section for:
            - ðŸ§ª Full test results
            - ðŸ“ˆ Coverage reports (JaCoCo)
            - ðŸ§¬ Mutation testing details (Pitest)
            - âš¡ Performance benchmarks (JMH)

            ---

            <sub>ðŸ’¡ **Phase 4 Update:** Threshold increased to 70% for higher quality standards. Use the mutation analysis script for guided improvements: \`./scripts/analyze-mutations.sh --verbose\`</sub>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # ============================================================================
      # Phase 7: Fail Job if Quality Gates Not Met
      # ============================================================================

      - name: Final Quality Gate Check
        if: steps.pitest.outcome == 'failure'
        run: |
          echo "::error::Quality gates failed. See details above."
          exit 1

  # ============================================================================
  # Separate Job: Check for Test Quality Regression
  # ============================================================================

  regression-check:
    name: Test Quality Regression Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run Pitest on PR branch
        run: |
          ./gradlew pitest --no-daemon
          cp build/reports/pitest/mutations.xml /tmp/pr-mutations.xml || echo "No PR mutations file"

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Run Pitest on base branch
        run: |
          ./gradlew pitest --no-daemon
          cp build/reports/pitest/mutations.xml /tmp/base-mutations.xml || echo "No base mutations file"

      - name: Compare Mutation Coverage
        run: |
          # Simple comparison - in production, use a proper diff tool
          echo "::notice::Comparing mutation coverage between base and PR..."
          echo "::notice::In production, implement proper mutation diff analysis"

          # This is a placeholder - a real implementation would parse and compare
          # the XML files to detect regressions

          echo "::notice::âœ… Regression check complete"
